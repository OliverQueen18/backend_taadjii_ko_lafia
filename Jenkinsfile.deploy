#!groovy
pipeline {
  agent any

  parameters {
    choice(
      name: 'DEPLOY_ENV',
      choices: ['prod', 'dev'],  // 'prod' est la premi√®re valeur = valeur par d√©faut
      description: 'Environnement de d√©ploiement'
    )
    booleanParam(
      name: 'PUSH_TO_REGISTRY',
      defaultValue: true,
      description: 'Pousser l\'image vers Docker Hub'
    )
    booleanParam(
      name: 'SKIP_TESTS',
      defaultValue: false,
      description: 'Ignorer les tests Maven'
    )
  }

  environment {
    // Configuration du serveur distant
    REMOTE_HOST = '180.149.197.244'
    REMOTE_USER = 'adminubuntu'
    REMOTE_DIR = '/home/adminubuntu/taadjii-ko-lafia'
    
    // Docker Hub
    DOCKER_REGISTRY = 'docker.io'
    DOCKER_USERNAME = 'oliverqueen18'  // Docker Hub usernames are case-insensitive, use lowercase
    DOCKER_IMAGE_NAME = 'backend_taadjii_ko_lafia'
    DOCKER_IMAGE_FULL = "${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}"
    
    // Credentials
    DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials')
    SSH_CREDENTIALS = credentials('ssh-server-credentials')
  }

  options {
    timeout(time: 60, unit: 'MINUTES')
    timestamps()
    buildDiscarder(logRotator(numToKeepStr: '10'))
  }

  stages {
    stage('Checkout') {
      steps {
        echo "üì¶ R√©cup√©ration du code source backend..."
        checkout scm
        script {
          env.GIT_COMMIT_SHORT = sh(
            script: 'git rev-parse --short HEAD',
            returnStdout: true
          ).trim()
          env.BUILD_TIMESTAMP = sh(
            script: 'date +%Y%m%d-%H%M%S',
            returnStdout: true
          ).trim()
          env.DOCKER_TAG = "${env.GIT_COMMIT_SHORT}-${env.BUILD_TIMESTAMP}"
        }
      }
    }

    stage('Build Maven') {
      steps {
        echo "üî® Compilation Maven..."
        script {
          // V√©rifier si le wrapper Maven existe, sinon utiliser mvn directement
          def mvnWrapper = sh(script: 'test -f ./mvnw && echo "./mvnw" || echo "mvn"', returnStdout: true).trim()
          def mvnCmd = params.SKIP_TESTS ? "${mvnWrapper} clean package -DskipTests" : "${mvnWrapper} clean package"
          
          sh """
            if [ -f ./mvnw ]; then
              chmod +x ./mvnw
            fi
            ${mvnCmd}
          """
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        echo "üê≥ Construction de l'image Docker backend..."
        script {
          // Utiliser le nom d'utilisateur en minuscules pour coh√©rence avec Docker Hub
          def imageName = "${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}"
          sh """
            docker build \
              --tag ${imageName}:${env.GIT_COMMIT_SHORT} \
              --tag ${imageName}:latest \
              --tag ${imageName}:${params.DEPLOY_ENV} \
              --tag ${imageName}:${env.DOCKER_TAG} \
              .
          """
        }
      }
    }

    stage('Push to Docker Hub') {
      when {
        expression { params.PUSH_TO_REGISTRY == true }
      }
      steps {
        echo "üì§ Envoi de l'image vers Docker Hub..."
        withCredentials([usernamePassword(
          credentialsId: 'dockerhub-credentials',
          usernameVariable: 'DOCKER_USER',
          passwordVariable: 'DOCKER_PASS'
        )]) {
          script {
            // Utiliser le nom d'utilisateur en minuscules pour coh√©rence
            def imageName = "${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}"
            sh """
              echo "\$DOCKER_PASS" | docker login docker.io -u "\$DOCKER_USER" --password-stdin
              docker push ${imageName}:${env.GIT_COMMIT_SHORT}
              docker push ${imageName}:latest
              docker push ${imageName}:${params.DEPLOY_ENV}
              docker push ${imageName}:${env.DOCKER_TAG}
              docker logout
            """
          }
        }
      }
    }

    stage('Update Docker Compose on Server') {
      steps {
        echo "üìù Mise √† jour du docker-compose.yml sur le serveur..."
        withCredentials([sshUserPrivateKey(
          credentialsId: 'ssh-server-credentials',
          keyFileVariable: 'SSH_KEY',
          usernameVariable: 'SSH_USER'
        )]) {
          script {
            // Mettre √† jour l'image dans le docker-compose.yml existant
            def imageName = "${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}"
            sh """
              chmod 600 \$SSH_KEY || true
              ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} \
                "cd ${REMOTE_DIR} && \
                 sed -i 's|image:.*backend_taadjii_ko_lafia.*|image: ${imageName}:latest|g' docker-compose.yml && \
                 sed -i '/backend:/,/^[[:space:]]*[a-z]/ { /build:/d; /context:/d; /dockerfile:/d; }' docker-compose.yml && \
                 sed -i '/backend:/a\\    image: ${imageName}:latest' docker-compose.yml"
            """
          }
        }
      }
    }

    stage('Deploy to Server') {
      steps {
        echo "üöÄ D√©ploiement du backend sur le serveur..."
        withCredentials([sshUserPrivateKey(
          credentialsId: 'ssh-server-credentials',
          keyFileVariable: 'SSH_KEY',
          usernameVariable: 'SSH_USER'
        )]) {
          script {
            // Pull l'image sur le serveur
            if (params.PUSH_TO_REGISTRY == true) {
              def imageName = "${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}"
              sh """
                chmod 600 \$SSH_KEY || true
                ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} \
                  "cd ${REMOTE_DIR} && docker pull ${imageName}:latest || true"
              """
            }
            
            // Red√©marrer seulement le service backend avec la nouvelle image
            sh """
              chmod 600 \$SSH_KEY || true
              ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} \
                "cd ${REMOTE_DIR} && \
                 docker-compose -f docker-compose.yml pull backend && \
                 docker-compose -f docker-compose.yml up -d --no-deps backend"
            """
          }
        }
      }
    }

    stage('Health Check') {
      steps {
        echo "üè• V√©rification de la sant√© du backend..."
        withCredentials([sshUserPrivateKey(
          credentialsId: 'ssh-server-credentials',
          keyFileVariable: 'SSH_KEY',
          usernameVariable: 'SSH_USER'
        )]) {
          script {
            sleep(time: 20, unit: 'SECONDS')
            
            sh """
              chmod 600 \$SSH_KEY || true
              ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} \
                "cd ${REMOTE_DIR} && docker-compose ps backend"
            """
            
            sh """
              chmod 600 \$SSH_KEY || true
              ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} \
                "cd ${REMOTE_DIR} && docker-compose logs --tail=30 backend"
            """
          }
        }
      }
    }
  }

  post {
    always {
      echo "üßπ Nettoyage..."
      sh 'docker logout || true'
    }
    success {
      echo """
        ‚úÖ D√©ploiement backend r√©ussi !
        
        Environnement: ${params.DEPLOY_ENV}
        Git Commit: ${env.GIT_COMMIT_SHORT}
        Build Timestamp: ${env.BUILD_TIMESTAMP}
        Docker Image: ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:latest
        
        URL d'acc√®s:
        - Backend API: http://${REMOTE_HOST}:8000/api
      """
    }
    failure {
      echo "‚ùå Le d√©ploiement backend a √©chou√©. Consultez les logs ci-dessus."
    }
  }
}

