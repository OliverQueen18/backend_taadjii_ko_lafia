#!groovy
pipeline {
  agent any

  parameters {
    booleanParam(
      name: 'FORCE_MAVEN_CLEAN',
      defaultValue: false,
      description: 'Forcer le nettoyage complet du cache Maven avant le build'
    )
    choice(
      name: 'DEPLOY_ENV',
      choices: ['dev', 'staging', 'production'],
      description: 'Environnement de d√©ploiement'
    )
    string(
      name: 'DOCKER_IMAGE_TAG',
      defaultValue: 'latest',
      description: 'Tag pour l\'image Docker (par d√©faut: latest, ou utilisez un num√©ro de version)'
    )
  }

  environment {
    DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials')
    DOCKER_REGISTRY = 'docker.io'
    DOCKER_USERNAME = 'OliverQueen18'
    DOCKER_IMAGE_NAME = 'backend_taadjii_ko_lafia'
    DOCKER_IMAGE_FULL = "${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}"
    MAVEN_CACHE = "${HOME}/.m2"
    JAVA_HOME = '/opt/java/openjdk'
    PATH = "${JAVA_HOME}/bin:${env.PATH}"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        script {
          env.GIT_COMMIT_SHORT = sh(
            script: 'git rev-parse --short HEAD',
            returnStdout: true
          ).trim()
          env.BUILD_TIMESTAMP = sh(
            script: 'date +%Y%m%d-%H%M%S',
            returnStdout: true
          ).trim()
          env.DOCKER_TAG = "${params.DOCKER_IMAGE_TAG == 'latest' ? 'latest' : params.DOCKER_IMAGE_TAG}-${env.GIT_COMMIT_SHORT}"
        }
      }
    }

    stage('Java Setup Verification') {
      agent {
        docker {
          image 'maven:3.9.6-eclipse-temurin-17'
          args "-u root -v ${MAVEN_CACHE}:/root/.m2"
        }
      }
      steps {
        script {
          echo "üîç === V√©rification de la Configuration Java ==="
          sh '''
            echo "JAVA_HOME: $JAVA_HOME"
            echo "PATH: $PATH"
            echo ""
            echo "=== Version Java ==="
            java -version
            echo ""
            echo "=== Version Maven ==="
            mvn --version
            echo ""
            echo "=== Informations de Build ==="
            echo "Git Commit: ${GIT_COMMIT_SHORT}"
            echo "Build Timestamp: ${BUILD_TIMESTAMP}"
            echo "Docker Tag: ${DOCKER_TAG}"
          '''
        }
      }
    }

    stage('Maven Build') {
      agent {
        docker {
          image 'maven:3.9.6-eclipse-temurin-17'
          args "-u root -v ${MAVEN_CACHE}:/root/.m2"
        }
      }
      steps {
        script {
          echo "üîç V√©rification du param√®tre FORCE_MAVEN_CLEAN : ${params.FORCE_MAVEN_CLEAN}"
          if (params.FORCE_MAVEN_CLEAN) {
            echo "üßπ Nettoyage complet du cache Maven..."
            sh 'rm -rf /root/.m2/repository'
          } else {
            echo "‚úÖ Utilisation du cache Maven existant."
          }
          
          echo "üîç === V√©rification Finale Java ==="
          sh '''
            echo "Java version utilis√©e pour la compilation:"
            java -version
            echo ""
            echo "Maven version:"
            mvn --version
          '''
          
          echo "üöÄ Ex√©cution du build Maven"
          sh 'mvn clean package -U -DskipTests'
          
          echo "‚úÖ Build Maven r√©ussi"
          archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
        }
      }
    }

    stage('Docker Build') {
      steps {
        script {
          echo "üê≥ === Construction de l'image Docker ==="
          echo "Image: ${DOCKER_IMAGE_FULL}"
          echo "Tag: ${DOCKER_TAG}"
          
          sh """
            docker build \
              --tag ${DOCKER_IMAGE_FULL}:${DOCKER_TAG} \
              --tag ${DOCKER_IMAGE_FULL}:latest \
              --build-arg BUILD_DATE="${BUILD_TIMESTAMP}" \
              --build-arg VCS_REF="${GIT_COMMIT_SHORT}" \
              --build-arg VERSION="${DOCKER_TAG}" \
              .
          """
          
          echo "‚úÖ Image Docker construite avec succ√®s"
        }
      }
    }

    stage('Docker Test') {
      steps {
        script {
          echo "üß™ === Test de l'image Docker ==="
          sh """
            docker images | grep ${DOCKER_IMAGE_NAME}
            docker inspect ${DOCKER_IMAGE_FULL}:${DOCKER_TAG}
          """
        }
      }
    }

    stage('Docker Login') {
      steps {
        script {
          echo "üîê === Connexion √† Docker Hub ==="
          withCredentials([usernamePassword(
            credentialsId: 'dockerhub-credentials',
            usernameVariable: 'DOCKER_USER',
            passwordVariable: 'DOCKER_PASS'
          )]) {
            sh """
              echo ${DOCKER_PASS} | docker login ${DOCKER_REGISTRY} -u ${DOCKER_USER} --password-stdin
            """
          }
        }
      }
    }

    stage('Docker Push') {
      when {
        anyOf {
          branch 'main'
          branch 'master'
          expression { params.DEPLOY_ENV == 'production' }
        }
      }
      steps {
        script {
          echo "üì§ === Push de l'image Docker ==="
          echo "Environnement: ${params.DEPLOY_ENV}"
          echo "Tag: ${DOCKER_TAG}"
          
          sh """
            docker push ${DOCKER_IMAGE_FULL}:${DOCKER_TAG}
            docker push ${DOCKER_IMAGE_FULL}:latest
          """
          
          echo "‚úÖ Image Docker push√©e avec succ√®s"
        }
      }
    }

    stage('Deploy Notification') {
      when {
        anyOf {
          branch 'main'
          branch 'master'
        }
      }
      steps {
        script {
          echo "üì¢ === Notification de d√©ploiement ==="
          echo """
            ‚úÖ D√©ploiement r√©ussi !
            
            Environnement: ${params.DEPLOY_ENV}
            Image Docker: ${DOCKER_IMAGE_FULL}:${DOCKER_TAG}
            Git Commit: ${env.GIT_COMMIT_SHORT}
            Build Timestamp: ${env.BUILD_TIMESTAMP}
            
            Pour d√©ployer:
            docker pull ${DOCKER_IMAGE_FULL}:${DOCKER_TAG}
            docker-compose up -d
          """
        }
      }
    }
  }

  post {
    always {
      script {
        echo "üßπ === Nettoyage ==="
        sh 'docker logout || true'
        // Nettoyer les images Docker orphelines (optionnel)
        sh 'docker image prune -f || true'
      }
    }
    success {
      echo "‚úÖ Pipeline termin√© avec succ√®s"
    }
    failure {
      echo "‚ùå Pipeline √©chou√©"
      // Vous pouvez ajouter des notifications ici (email, Slack, etc.)
    }
  }
}
