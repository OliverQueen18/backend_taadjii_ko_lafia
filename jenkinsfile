#!groovy
pipeline {
  agent any

  parameters {
    booleanParam(
      name: 'FORCE_MAVEN_CLEAN',
      defaultValue: false,
      description: 'Forcer le nettoyage complet du cache Maven avant le build'
    )
  }

  environment {
    DOCKERHUB_CREDENTIALS = credentials('github-token')
    MAVEN_CACHE = "${HOME}/.m2"
    JAVA_HOME = '/opt/java/openjdk'  // Java 17 dans l'image Maven
    PATH = "${JAVA_HOME}/bin:${env.PATH}"
  }

  stages {

    stage('Java Setup Verification') {
      agent {
        docker {
          image 'maven:3.9.6-eclipse-temurin-17'
          args "-u root -v ${MAVEN_CACHE}:/root/.m2"
        }
      }
      steps {
        script {
          echo "üîç === V√©rification de la Configuration Java ==="
          sh '''
            echo "JAVA_HOME: $JAVA_HOME"
            echo "PATH: $PATH"
            echo ""
            echo "=== Version Java ==="
            java -version
            echo ""
            echo "=== Version Maven ==="
            mvn --version
            echo ""
            echo "=== V√©rification des Variables d'Environnement ==="
            echo "JAVA_HOME: $JAVA_HOME"
            echo "MAVEN_OPTS: $MAVEN_OPTS"
          '''
        }
      }
    }

    stage('Maven Install') {
      agent {
        docker {
          image 'maven:3.9.6-eclipse-temurin-17'
          args "-u root -v ${MAVEN_CACHE}:/root/.m2"
        }
      }
      steps {
        script {
          echo "üîç V√©rification du param√®tre FORCE_MAVEN_CLEAN : ${params.FORCE_MAVEN_CLEAN}"
          if (params.FORCE_MAVEN_CLEAN) {
            echo "üßπ Nettoyage complet du cache Maven..."
            sh 'rm -rf /root/.m2/repository'
          } else {
            echo "‚úÖ Utilisation du cache Maven existant."
          }
          
          echo "üîç === V√©rification Finale Java ==="
          sh '''
            echo "Java version utilis√©e pour la compilation:"
            java -version
            echo ""
            echo "Maven version:"
            mvn --version
            echo ""
            echo "Variables d'environnement:"
            echo "JAVA_HOME: $JAVA_HOME"
            echo "MAVEN_OPTS: $MAVEN_OPTS"
          '''
          
          echo "üöÄ Ex√©cution du build Maven (avec for√ßage des snapshots -U)"
          sh 'mvn clean install -U -DskipTests'
        }
      }
    }

    stage('Docker Build') {
      agent any
      steps {
        sh 'docker build -t cookingbenlee/api-cooking-ben:mod-partage-recettes .'
      }
    }

    stage('Login') {
      steps {
        sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
      }
    }

    stage('Push') {
      steps {
        sh 'docker push OliverQueen18/backend_taadjii_ko_lafia'
      }
    }
  }

  post {
    always {
      sh 'docker logout'
    }
  }
}
